# AEGEN - Quality Gates por Fase (Puertas de Calidad)
# Archivo de configuración que define los controles de calidad requeridos para cada fase del proyecto.
# Este archivo es consumido por el script scripts/quality_gates.py.

# Versión del esquema para compatibilidad futura
version: "1.0"

# Definición de fases y sus puertas de calidad (quality gates)
phases:

  # Fase 3A: MasterRouter Básico
  # Enfoque: Establecer base funcional con pruebas mínimas
  Fase_3A:
    description: "MasterRouter Básico - Enrutamiento funcional sin LLM"
    required_checks:
      - name: "lint"
        command: "make lint"
        description: "Análisis estático con ruff y mypy"
        timeout: 120

      - name: "unit_tests"
        command: "make test"
        description: "Pruebas unitarias básicas"
        timeout: 300

      - name: "integration_tests"
        command: "pytest tests/integration/ -v"
        description: "Pruebas de integración para webhooks y orquestador"
        timeout: 180

      - name: "manual_e2e"
        command: "echo 'Prueba E2E manual requerida'"
        description: "Prueba E2E manual: Telegram → Transcripción"
        manual: true

    coverage_requirements:
      unit: 60
      integration: 40

    allowed_failures:
      - "manual_e2e"  # Se permite fallar en esta fase

  # Fase 3B: Memoria de Sesión
  # Enfoque: Añadir persistencia y pruebas de estado
  Fase_3B:
    description: "Memoria de Sesión - Estado conversacional persistente"
    required_checks:
      - name: "lint"
        command: "make lint"
        description: "Análisis estático con ruff y mypy"
        timeout: 120

      - name: "unit_tests"
        command: "make test"
        description: "Pruebas unitarias"
        timeout: 300

      - name: "integration_tests"
        command: "pytest tests/integration/ -v"
        description: "Pruebas de integración"
        timeout: 180

      - name: "redis_persistence_tests"
        command: "pytest tests/integration/test_redis_persistence.py -v"
        description: "Pruebas específicas de persistencia en Redis"
        timeout: 120

      - name: "load_test_basic"
        command: "pytest tests/load/test_basic_load.py -v"
        description: "Prueba de carga básica (10 usuarios concurrentes)"
        timeout: 300

    coverage_requirements:
      unit: 75
      integration: 60

    # Controles adicionales que se pueden añadir opcionalmente
    optional_checks:
      - name: "memory_leak_check"
        command: "python scripts/check_memory_leaks.py"
        description: "Verificación básica de fugas de memoria"

  # Fase 3C: TCC Specialist (Especialista TCC)
  # Enfoque: Sistema completo con especialista funcional
  Fase_3C:
    description: "Especialista TCC - Funcional con integración de perfil"
    required_checks:
      - name: "lint"
        command: "make lint"
        description: "Análisis estático con ruff y mypy"
        timeout: 120

      - name: "unit_tests"
        command: "make test"
        description: "Pruebas unitarias completas"
        timeout: 400

      - name: "integration_tests"
        command: "pytest tests/integration/ -v"
        description: "Pruebas de integración"
        timeout: 240

      - name: "e2e_automation"
        command: "pytest tests/e2e/ -v"
        description: "Pruebas E2E automatizadas"
        timeout: 600

      - name: "performance_test"
        command: "pytest tests/performance/ -v"
        description: "Pruebas de rendimiento y latencia"
        timeout: 300

    coverage_requirements:
      unit: 85
      integration: 75
      e2e: 90

  # Producción: Todas las verificaciones
  Produccion:
    description: "Producción - Máximo rigor y verificaciones completas"
    required_checks:
      - name: "full_ci_cd"
        command: "make verify-production"
        description: "Suite completa de CI/CD"
        timeout: 900

      - name: "security_scan"
        command: "bandit -r src/ && safety check"
        description: "Escaneo de seguridad completo"
        timeout: 180

      - name: "chaos_engineering"
        command: "python scripts/chaos_tests.py"
        description: "Pruebas de ingeniería del caos"
        timeout: 600

      - name: "performance_benchmark"
        command: "pytest tests/benchmark/ -v"
        description: "Pruebas comparativas (benchmarks) de rendimiento"
        timeout: 900

    coverage_requirements:
      unit: 90
      integration: 85
      e2e: 95
      mutation: 97  # Pruebas de mutación para código crítico

# Configuración global
global:
  # Tiempo de espera por defecto para cualquier control
  default_timeout: 300

  # Archivos que siempre deben pasar análisis estático independiente de la fase
  always_lint:
    - "src/"
    - "tests/"
    - "scripts/"

  # Comandos que se ejecutan antes de cualquier puerta (gate)
  pre_checks:
    - "git status --porcelain || echo 'Directorio de trabajo de Git no está limpio'"
    - "python --version"

  # Comandos que se ejecutan después de todas las puertas
  post_checks:
    - "make sync-docs"  # Actualizar documentación después de las pruebas
